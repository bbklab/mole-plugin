#!/bin/bash

basedir="$(cd $(dirname $0);pwd)"
destdir="/data/esop_codes"
autorpm="${basedir}/rpm_build/autorpm"
args1="basic tarball"
args2="mail  tarball"

check_rc() {
  if [ $? == 0 ]; then
        echo -e " -- $(date +%F_%T)  succed!  ${*}"
  else
        echo -e " -- $(date +%F_%T)  failed!  ${*}"; exit 1
  fi
}

# def spec files

if [ "$(id -u)" != "0" ]; then
  echo " root privileges required! "
  exit 1
fi


spec_dir="$basedir/rpm_build/spec_files/"
spec_files=(
	"esop-plugingroup-mail.spec"
)

for((i=0;i<=${#spec_files[*]}-1;i++))
do
	if [ -f "${spec_dir}/${spec_files[$i]}" ]; then
		/bin/cp  -f "${spec_dir}/${spec_files[$i]}"  "${destdir}/${spec_files[$i]}"
		check_rc "publish ${spec_files[$i]}"
	fi
done


filename1=$( eval "${autorpm} ${args1}" )
check_rc "make rpm for $filename1"

ls "${filename1}" >/dev/null 2>&1
check_rc "check path: ${filename1}"

/bin/cp -f "${filename1}" "${destdir}/"
check_rc "copy to ${destdir}/${filename1##*/}"


filename2=$( eval "${autorpm} ${args2}" )
check_rc "make rpm for $filename2"

ls "${filename2}" >/dev/null 2>&1
check_rc "check path: ${filename2}"

/bin/cp -f "${filename2}" "${destdir}/"
check_rc "copy to ${destdir}/${filename2##*/}"

${autorpm} clean
check_rc "rpm clean"
